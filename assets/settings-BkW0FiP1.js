import{r as n,j as e,b as w,u as te,F as ae,i as re,k as ne,l as M,m as L,h as _,n as oe,o as le,f as B,d as x}from"./dashboard-54hzYEKp.js";import{E as de,p as ie,t as ce,r as h,o as me,v as ue,h as H,k as xe,f as he,w as I,x as D}from"./firebase-BWT5hCBR.js";const V=n.createContext();function ge(){return n.useContext(V)}function we({children:c}){const[y,C]=n.useState([]),N=n.useCallback((l,j="info")=>{const v=Date.now();C(f=>[...f,{id:v,message:l,type:j}]),setTimeout(()=>{C(f=>f.filter(P=>P.id!==v))},4e3)},[]),g=l=>{switch(l){case"error":return"bg-red-600 text-white border border-red-700";case"success":return"bg-green-600 text-white border border-green-700";case"warning":return"bg-yellow-500 text-white border border-yellow-600";default:return"bg-blue-600 text-white border border-blue-700"}},b=l=>{switch(l){case"error":return"❌";case"success":return"✓";case"warning":return"⚠️";default:return"ℹ️"}};return e.jsxs(V.Provider,{value:{showToast:N},children:[c,e.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-3 max-w-sm",children:y.map(l=>e.jsxs("div",{className:`px-5 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-in fade-in slide-in-from-right-5 ${g(l.type)}`,children:[e.jsx("span",{className:"text-lg",children:b(l.type)}),e.jsx("span",{className:"font-medium text-sm",children:l.message})]},l.id))})]})}function be({isOpen:c,onClose:y,onSuccess:C}){const[N,g]=n.useState(""),[b,l]=n.useState(""),[j,v]=n.useState(""),[f,P]=n.useState(!1),[k,p]=n.useState(""),{showToast:S}=ge(),m=async d=>{if(d.preventDefault(),p(""),!N){p("Current password is required");return}if(b.length<6){p("New password must be at least 6 characters");return}if(b!==j){p("Passwords do not match");return}if(b===N){p("New password must be different from current password");return}P(!0);try{const u=w.currentUser,A=de.credential(u.email,N);await ie(u,A),await ce(u,b),g(""),l(""),v(""),S("Password changed successfully!","success"),C&&C(),y()}catch(u){console.error(u),u.code==="auth/wrong-password"?p("Current password is incorrect"):p("Failed to change password: "+u.message)}finally{P(!1)}};return c?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-8 max-w-md w-full mx-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:"Change Password"}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[k&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded",children:k}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Current Password"}),e.jsx("input",{type:"password",value:N,onChange:d=>g(d.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"New Password"}),e.jsx("input",{type:"password",value:b,onChange:d=>l(d.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:j,onChange:d=>v(d.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{className:"flex gap-3 pt-6",children:[e.jsx("button",{type:"button",onClick:y,disabled:f,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors disabled:opacity-50",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:f,className:"flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50",children:f?"Changing...":"Change Password"})]})]})]})}):null}function fe(){var q;const{rooms:c,setRooms:y}=te(),[C,N]=n.useState(null),[g,b]=n.useState(""),[l,j]=n.useState(!1),[v,f]=n.useState(!1),[P,k]=n.useState({}),[p,S]=n.useState({}),[m,d]=n.useState({open:!1,title:"",message:"",onConfirm:null,showDeleteOption:!1,deleteOption:!0}),[u,A]=n.useState(!1),[W,T]=n.useState(!1),[R,O]=n.useState([]),[i,F]=n.useState({open:!1,mode:"add",id:null,label:"",number:""});n.useEffect(()=>{(async()=>{if(w.currentUser){const a=await ue(H(B,"users",w.currentUser.uid));a.exists()&&(N(a.data().role),b(a.data().displayName||w.currentUser.displayName||""))}})()},[]);const G=async()=>{if(!g.trim()){alert("Name cannot be empty");return}f(!0);try{w.currentUser&&await xe(w.currentUser,{displayName:g}),w.currentUser&&await he(H(B,"users",w.currentUser.uid),{displayName:g}),j(!1),alert("Name updated successfully!")}catch(s){console.error(s),alert("Failed to update name: "+s.message)}finally{f(!1)}};n.useEffect(()=>{const s={};c.forEach(a=>{a.nodeId&&(s[a.nodeId]=a.roomName)}),k(a=>{const t={...a};return c.forEach(r=>{r.nodeId&&!(r.nodeId in t)&&(t[r.nodeId]=r.roomName)}),t}),S(a=>{const t={...a},r=new Set(c.map(o=>o.nodeId).filter(Boolean));return Object.keys(t).forEach(o=>{r.has(o)||delete t[o]}),c.forEach(o=>{o.nodeId&&!(o.nodeId in t)&&(t[o.nodeId]=!1)}),t})},[c]),n.useEffect(()=>{const s=h(x,"phone_numbers"),a=me(s,t=>{if(t.exists()){const r=t.val(),o=Object.entries(r).map(([$,E])=>({id:$,...E}));O(o)}else O([])},t=>{console.error("Failed to load phone numbers:",t),O([])});return()=>a()},[]);const J=async s=>{const a=P[s]??"";try{await I(h(x,`room_names/${s}`),a),y(t=>t.map(r=>r.nodeId===s?{...r,roomName:a,customName:a}:r))}catch(t){console.error("Failed to save room name:",t),alert("Failed to save room name")}},K=s=>async function(a=!0){try{if(a){await D(h(x,`sensor_data/${s}`)),await D(h(x,`room_names/${s}`));try{const r=(await get(h(x,"alerts"))).val()||{},o=[];Object.entries(r).forEach(([$,E])=>{E&&(E.node===s||E.nodeId===s)&&o.push(D(h(x,`alerts/${$}`)))}),o.length>0&&await Promise.all(o)}catch(t){console.error("Failed to remove related alerts:",t)}y(t=>t.filter(r=>r.nodeId!==s))}else{try{await I(h(x,`room_meta/${s}/archived`),!0)}catch(t){console.error("Failed to set archived flag:",t)}y(t=>t.map(r=>r.nodeId===s?{...r,archived:!0}:r))}}catch(t){console.error("Failed to remove room:",t),alert("Failed to remove room")}},Q=async s=>{const a=c.find(r=>r.nodeId===s),t=!(a&&a.archived);try{await I(h(x,`room_meta/${s}/archived`),t),y(r=>r.map(o=>o.nodeId===s?{...o,archived:t}:o))}catch(r){console.error("Failed to toggle archive:",r),alert("Failed to update archive status")}},U=({title:s,message:a,onConfirm:t,showDeleteOption:r})=>{d({open:!0,title:s,message:a,onConfirm:t,showDeleteOption:!!r,deleteOption:!0})},X=async()=>{if(!m.onConfirm){d({open:!1,title:"",message:"",onConfirm:null});return}try{A(!0),await m.onConfirm(m.deleteOption)}catch(s){console.error("Action failed:",s)}finally{A(!1),d({open:!1,title:"",message:"",onConfirm:null})}},Y=()=>{F({open:!0,mode:"add",id:null,label:"",number:""})},Z=s=>{F({open:!0,mode:"edit",id:s.id,label:s.label||"",number:s.number||""})},z=()=>{F({open:!1,mode:"add",id:null,label:"",number:""})},ee=async()=>{if(!i.label.trim()||!i.number.trim()){alert("Please fill in both label and phone number");return}try{if(i.mode==="add"){const s=`phone_${Date.now()}`;await I(h(x,`phone_numbers/${s}`),{label:i.label.trim(),number:i.number.trim()})}else await I(h(x,`phone_numbers/${i.id}`),{label:i.label.trim(),number:i.number.trim()});z()}catch(s){console.error("Failed to save phone number:",s),alert("Failed to save phone number")}},se=s=>{U({title:"Delete phone number",message:"Are you sure you want to delete this phone number?",onConfirm:async()=>{try{await D(h(x,`phone_numbers/${s}`)),O(a=>a.filter(t=>t.id!==s))}catch(a){console.error("Failed to delete phone number:",a),alert("Failed to delete phone number")}}})};return e.jsxs("div",{className:"p-6 max-w-5xl mx-auto",children:[e.jsx("div",{className:"flex items-start gap-4 mb-6",children:e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-semibold",children:"Settings"})})}),e.jsxs("div",{className:"mb-8 bg-white rounded-xl p-6 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4 flex items-center gap-2",children:[e.jsx(ae,{className:"text-blue-600"}),"Account Information"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Full Name"}),l?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:g,onChange:s=>b(s.target.value),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{onClick:G,disabled:v,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:v?"Saving...":"Save"}),e.jsx("button",{onClick:()=>j(!1),className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Cancel"})]}):e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-gray-800",children:g||"Not set"}),e.jsx("button",{onClick:()=>j(!0),className:"text-blue-600 hover:text-blue-700 text-sm font-medium",children:"Edit"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Email"}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg text-gray-800",children:(q=w.currentUser)==null?void 0:q.email})]})]})]}),e.jsxs("div",{className:"mb-8 bg-white rounded-xl p-6 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4 flex items-center gap-2",children:[e.jsx(re,{className:"text-red-600"}),"Account Security"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Manage your account password"}),e.jsx("button",{onClick:()=>T(!0),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Change Password"})]}),C==="admin"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Room Management"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Configure and manage your monitored rooms"})]}),e.jsxs("div",{className:"space-y-4",children:[c.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No rooms found."}),c.map((s,a)=>e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm flex flex-col md:flex-row items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full md:w-auto",children:[e.jsx("div",{className:"w-14 h-14 bg-slate-900/10 rounded-lg flex items-center justify-center",children:e.jsx(ne,{className:"text-2xl md:text-3xl text-gray-800"})}),e.jsxs("div",{className:"w-full",children:[p[s.nodeId]?e.jsx("input",{type:"text",className:"w-full text-lg md:text-xl font-semibold text-slate-900 uppercase border rounded px-3 py-2",value:P[s.nodeId]??s.roomName,onChange:t=>k(r=>({...r,[s.nodeId]:t.target.value}))}):e.jsx("div",{className:"text-base md:text-lg font-semibold text-slate-900 uppercase",children:s.roomName}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${s.status==="Active"&&!s.archived?"bg-emerald-100 text-emerald-700":"bg-gray-200 text-gray-700"}`,children:s.status==="Active"&&!s.archived?"Active":s.archived?"Archived":s.status}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Node ID:"," ",e.jsx("span",{className:"font-medium text-gray-700",children:s.nodeId||"unknown"})]})]})]})]}),e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"w-full md:w-auto flex items-center justify-end md:justify-start",children:e.jsx("div",{className:"flex flex-wrap gap-2 w-full md:w-auto",children:p[s.nodeId]?e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"flex items-center gap-2 px-3 md:px-4 py-2 bg-red-600 text-white rounded-lg text-sm cursor-pointer flex-shrink-0",onClick:async()=>{await J(s.nodeId),S(t=>({...t,[s.nodeId]:!1}))},children:[e.jsx(M,{className:"w-4 h-4 text-white"}),"Save"]}),e.jsx("button",{className:"px-3 md:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm cursor-pointer flex-shrink-0",onClick:()=>{k(t=>({...t,[s.nodeId]:s.roomName})),S(t=>({...t,[s.nodeId]:!1}))},children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"flex items-center gap-2 px-3 md:px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg text-sm hover:bg-gray-50 transition-colors cursor-pointer flex-shrink-0",onClick:()=>S(t=>({...t,[s.nodeId]:!0})),children:[e.jsx(M,{className:"w-4 h-4"}),"Edit"]}),e.jsxs("button",{className:"px-3 md:px-4 py-2 bg-slate-700 text-white rounded-lg text-sm flex items-center gap-2 hover:bg-slate-800 transition-colors cursor-pointer flex-shrink-0",onClick:()=>U({title:s.archived?"Unarchive room":"Archive room",message:s.archived?`Unarchive ${s.roomName}? It will reappear on the dashboard.`:`Archive ${s.roomName}? It will be hidden from the dashboard but not deleted.`,onConfirm:()=>Q(s.nodeId)}),children:[e.jsx(L,{className:"w-4 h-4 text-white"}),s.archived?"Unarchive":"Archive"]}),e.jsxs("button",{className:"px-3 md:px-4 py-2 bg-red-600 text-white rounded-lg text-sm flex items-center gap-2 hover:bg-red-700 transition-colors cursor-pointer flex-shrink-0",onClick:()=>U({title:"Remove room",message:`Remove ${s.roomName}? Choose whether to also delete its sensor data and related alerts. This cannot be undone.`,onConfirm:K(s.nodeId),showDeleteOption:!0}),children:[e.jsx(_,{className:"w-4 h-4 text-white"}),"Delete"]})]})})})]},s.nodeId||a))]}),e.jsxs("div",{className:"mt-12 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium",children:"Phone Numbers"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Manage emergency and notification contacts"})]}),e.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors cursor-pointer",onClick:Y,children:[e.jsx(oe,{className:"w-4 h-4"}),"Add Phone Number"]})]}),e.jsxs("div",{className:"space-y-4",children:[R.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No phone numbers found."}),R.map(s=>e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-gray-200 flex flex-col md:flex-row items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full md:w-auto flex-1",children:[e.jsx("div",{className:"w-14 h-14 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(le,{className:"text-2xl text-red-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-base font-semibold text-gray-900",children:s.label}),e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:s.number})]})]}),e.jsxs("div",{className:"w-full md:w-auto flex items-center gap-3",children:[e.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>Z(s),children:[e.jsx(M,{className:"w-4 h-4"}),"Edit"]}),e.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors cursor-pointer",onClick:()=>se(s.id),children:[e.jsx(_,{className:"w-4 h-4"}),"Delete"]})]})]},s.id))]})]}),i.open&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",role:"dialog","aria-modal":"true","aria-labelledby":"phone-modal-title",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg max-w-md w-full mx-4 p-6",children:[e.jsx("h3",{id:"phone-modal-title",className:"text-lg font-semibold text-gray-900 mb-4",children:i.mode==="add"?"Add Phone Number":"Edit Phone Number"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Label"}),e.jsx("input",{type:"text",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",placeholder:"e.g., Emergency Contact",value:i.label,onChange:s=>F(a=>({...a,label:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone Number"}),e.jsx("input",{type:"tel",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",placeholder:"e.g., +639456789012",value:i.number,onChange:s=>F(a=>({...a,number:s.target.value}))})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{className:"px-6 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors cursor-pointer",onClick:z,children:"Cancel"}),e.jsx("button",{className:"px-6 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors cursor-pointer",onClick:ee,children:i.mode==="add"?"Add":"Save"})]})]})}),m.open&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-title",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg max-w-lg w-full mx-4 p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 ${m.showDeleteOption?"bg-red-100":"bg-slate-700"}`,children:m.showDeleteOption?e.jsx(_,{className:"w-5 h-5 text-red-600"}):e.jsx(L,{className:"w-5 h-5 text-white"})}),e.jsx("div",{children:e.jsx("h3",{id:"confirm-title",className:"text-lg font-semibold text-gray-900",children:m.title})})]}),e.jsx("p",{className:"text-sm text-gray-700 mb-6",children:m.message}),m.showDeleteOption&&e.jsx("div",{className:"mb-6",children:e.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:m.deleteOption,onChange:()=>d(s=>({...s,deleteOption:!s.deleteOption})),className:"w-5 h-5 accent-red-600 cursor-pointer"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Also delete sensor data and related alerts"})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:"px-6 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50",onClick:()=>d({open:!1,title:"",message:"",onConfirm:null}),disabled:u,children:"Cancel"}),e.jsx("button",{className:"px-6 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors disabled:opacity-50",onClick:X,disabled:u,children:u?"Please wait...":"Confirm"})]})]})})]}),e.jsx(be,{isOpen:W,onClose:()=>T(!1),onSuccess:()=>{}})]})}const Ne=Object.freeze(Object.defineProperty({__proto__:null,default:fe},Symbol.toStringTag,{value:"Module"}));export{be as C,Ne as S,we as T,ge as u};
