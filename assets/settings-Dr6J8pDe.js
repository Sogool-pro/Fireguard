import{r as o,j as e,b,u as se,F as te,i as ae,k as re,l as M,m as L,h as _,n as oe,o as ne,f as B,d as u}from"./dashboard-CcZ1-o9M.js";import{E as le,n as de,p as ie,r as x,o as ce,t as me,h as H,k as ue,f as xe,v as E,w as U}from"./firebase-CzWliFlt.js";import{u as he}from"./users-z4gfihOL.js";function ge({isOpen:h,onClose:y,onSuccess:I}){const[N,f]=o.useState(""),[p,A]=o.useState(""),[w,k]=o.useState(""),[j,P]=o.useState(!1),[v,g]=o.useState(""),{showToast:C}=he(),i=async l=>{if(l.preventDefault(),g(""),!N){g("Current password is required");return}if(p.length<6){g("New password must be at least 6 characters");return}if(p!==w){g("Passwords do not match");return}if(p===N){g("New password must be different from current password");return}P(!0);try{const c=b.currentUser,m=le.credential(c.email,N);await de(c,m),await ie(c,p),f(""),A(""),k(""),C("Password changed successfully!","success"),I&&I(),y()}catch(c){console.error(c);let m="";switch(c.code){case"auth/wrong-password":m="Current password is incorrect. Please try again.";break;case"auth/weak-password":m="New password is too weak. Please use at least 6 characters.";break;case"auth/requires-recent-login":m="Please log out and log back in before changing your password.";break;case"auth/user-disabled":m="This account has been disabled. Please contact support.";break;default:m=c.message||"Failed to change password. Please try again."}g(m)}finally{P(!1)}};return h?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-8 max-w-md w-full mx-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:"Change Password"}),e.jsxs("form",{onSubmit:i,className:"space-y-4",children:[v&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded",children:v}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Current Password"}),e.jsx("input",{type:"password",value:N,onChange:l=>f(l.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"New Password"}),e.jsx("input",{type:"password",value:p,onChange:l=>A(l.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:w,onChange:l=>k(l.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",required:!0})]}),e.jsxs("div",{className:"flex gap-3 pt-6",children:[e.jsx("button",{type:"button",onClick:y,disabled:j,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors disabled:opacity-50",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:j,className:"flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50",children:j?"Changing...":"Change Password"})]})]})]})}):null}function be(){var z;const{rooms:h,setRooms:y}=se(),[I,N]=o.useState(null),[f,p]=o.useState(""),[A,w]=o.useState(!1),[k,j]=o.useState(!1),[P,v]=o.useState({}),[g,C]=o.useState({}),[i,l]=o.useState({open:!1,title:"",message:"",onConfirm:null,showDeleteOption:!1,deleteOption:!0}),[c,m]=o.useState(!1),[V,R]=o.useState(!1),[T,O]=o.useState([]),[d,S]=o.useState({open:!1,mode:"add",id:null,label:"",number:""});o.useEffect(()=>{(async()=>{if(b.currentUser){const a=await me(H(B,"users",b.currentUser.uid));a.exists()&&(N(a.data().role),p(a.data().displayName||b.currentUser.displayName||""))}})()},[]);const W=async()=>{if(!f.trim()){alert("Name cannot be empty");return}j(!0);try{b.currentUser&&await ue(b.currentUser,{displayName:f}),b.currentUser&&await xe(H(B,"users",b.currentUser.uid),{displayName:f}),w(!1),alert("Name updated successfully!")}catch(s){console.error(s),alert("Failed to update name: "+s.message)}finally{j(!1)}};o.useEffect(()=>{const s={};h.forEach(a=>{a.nodeId&&(s[a.nodeId]=a.roomName)}),v(a=>{const t={...a};return h.forEach(r=>{r.nodeId&&!(r.nodeId in t)&&(t[r.nodeId]=r.roomName)}),t}),C(a=>{const t={...a},r=new Set(h.map(n=>n.nodeId).filter(Boolean));return Object.keys(t).forEach(n=>{r.has(n)||delete t[n]}),h.forEach(n=>{n.nodeId&&!(n.nodeId in t)&&(t[n.nodeId]=!1)}),t})},[h]),o.useEffect(()=>{const s=x(u,"phone_numbers"),a=ce(s,t=>{if(t.exists()){const r=t.val(),n=Object.entries(r).map(([$,F])=>({id:$,...F}));O(n)}else O([])},t=>{console.error("Failed to load phone numbers:",t),O([])});return()=>a()},[]);const G=async s=>{const a=P[s]??"";try{await E(x(u,`room_names/${s}`),a),y(t=>t.map(r=>r.nodeId===s?{...r,roomName:a,customName:a}:r))}catch(t){console.error("Failed to save room name:",t),alert("Failed to save room name")}},J=s=>async function(a=!0){try{if(a){await U(x(u,`sensor_data/${s}`)),await U(x(u,`room_names/${s}`));try{const r=(await get(x(u,"alerts"))).val()||{},n=[];Object.entries(r).forEach(([$,F])=>{F&&(F.node===s||F.nodeId===s)&&n.push(U(x(u,`alerts/${$}`)))}),n.length>0&&await Promise.all(n)}catch(t){console.error("Failed to remove related alerts:",t)}y(t=>t.filter(r=>r.nodeId!==s))}else{try{await E(x(u,`room_meta/${s}/archived`),!0)}catch(t){console.error("Failed to set archived flag:",t)}y(t=>t.map(r=>r.nodeId===s?{...r,archived:!0}:r))}}catch(t){console.error("Failed to remove room:",t),alert("Failed to remove room")}},K=async s=>{const a=h.find(r=>r.nodeId===s),t=!(a&&a.archived);try{await E(x(u,`room_meta/${s}/archived`),t),y(r=>r.map(n=>n.nodeId===s?{...n,archived:t}:n))}catch(r){console.error("Failed to toggle archive:",r),alert("Failed to update archive status")}},D=({title:s,message:a,onConfirm:t,showDeleteOption:r})=>{l({open:!0,title:s,message:a,onConfirm:t,showDeleteOption:!!r,deleteOption:!0})},Q=async()=>{if(!i.onConfirm){l({open:!1,title:"",message:"",onConfirm:null});return}try{m(!0),await i.onConfirm(i.deleteOption)}catch(s){console.error("Action failed:",s)}finally{m(!1),l({open:!1,title:"",message:"",onConfirm:null})}},X=()=>{S({open:!0,mode:"add",id:null,label:"",number:""})},Y=s=>{S({open:!0,mode:"edit",id:s.id,label:s.label||"",number:s.number||""})},q=()=>{S({open:!1,mode:"add",id:null,label:"",number:""})},Z=async()=>{if(!d.label.trim()||!d.number.trim()){alert("Please fill in both label and phone number");return}try{if(d.mode==="add"){const s=`phone_${Date.now()}`;await E(x(u,`phone_numbers/${s}`),{label:d.label.trim(),number:d.number.trim()})}else await E(x(u,`phone_numbers/${d.id}`),{label:d.label.trim(),number:d.number.trim()});q()}catch(s){console.error("Failed to save phone number:",s),alert("Failed to save phone number")}},ee=s=>{D({title:"Delete phone number",message:"Are you sure you want to delete this phone number?",onConfirm:async()=>{try{await U(x(u,`phone_numbers/${s}`)),O(a=>a.filter(t=>t.id!==s))}catch(a){console.error("Failed to delete phone number:",a),alert("Failed to delete phone number")}}})};return e.jsxs("div",{className:"p-6 max-w-5xl mx-auto",children:[e.jsx("div",{className:"flex items-start gap-4 mb-6",children:e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-semibold",children:"Settings"})})}),e.jsxs("div",{className:"mb-8 bg-white rounded-xl p-6 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4 flex items-center gap-2",children:[e.jsx(te,{className:"text-blue-600"}),"Account Information"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Full Name"}),A?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:f,onChange:s=>p(s.target.value),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{onClick:W,disabled:k,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:k?"Saving...":"Save"}),e.jsx("button",{onClick:()=>w(!1),className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Cancel"})]}):e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-gray-800",children:f||"Not set"}),e.jsx("button",{onClick:()=>w(!0),className:"text-blue-600 hover:text-blue-700 text-sm font-medium",children:"Edit"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Email"}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg text-gray-800",children:(z=b.currentUser)==null?void 0:z.email})]})]})]}),e.jsxs("div",{className:"mb-8 bg-white rounded-xl p-6 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-medium mb-4 flex items-center gap-2",children:[e.jsx(ae,{className:"text-red-600"}),"Account Security"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Manage your account password"}),e.jsx("button",{onClick:()=>R(!0),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Change Password"})]}),I==="admin"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Room Management"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Configure and manage your monitored rooms"})]}),e.jsxs("div",{className:"space-y-4",children:[h.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No rooms found."}),h.map((s,a)=>e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm flex flex-col md:flex-row items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full md:w-auto",children:[e.jsx("div",{className:"w-14 h-14 bg-slate-900/10 rounded-lg flex items-center justify-center",children:e.jsx(re,{className:"text-2xl md:text-3xl text-gray-800"})}),e.jsxs("div",{className:"w-full",children:[g[s.nodeId]?e.jsx("input",{type:"text",className:"w-full text-lg md:text-xl font-semibold text-slate-900 uppercase border rounded px-3 py-2",value:P[s.nodeId]??s.roomName,onChange:t=>v(r=>({...r,[s.nodeId]:t.target.value}))}):e.jsx("div",{className:"text-base md:text-lg font-semibold text-slate-900 uppercase",children:s.roomName}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${s.status==="Active"&&!s.archived?"bg-emerald-100 text-emerald-700":"bg-gray-200 text-gray-700"}`,children:s.status==="Active"&&!s.archived?"Active":s.archived?"Archived":s.status}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Node ID:"," ",e.jsx("span",{className:"font-medium text-gray-700",children:s.nodeId||"unknown"})]})]})]})]}),e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"w-full md:w-auto flex items-center justify-end md:justify-start",children:e.jsx("div",{className:"flex flex-wrap gap-2 w-full md:w-auto",children:g[s.nodeId]?e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"flex items-center gap-2 px-3 md:px-4 py-2 bg-red-600 text-white rounded-lg text-sm cursor-pointer flex-shrink-0",onClick:async()=>{await G(s.nodeId),C(t=>({...t,[s.nodeId]:!1}))},children:[e.jsx(M,{className:"w-4 h-4 text-white"}),"Save"]}),e.jsx("button",{className:"px-3 md:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm cursor-pointer flex-shrink-0",onClick:()=>{v(t=>({...t,[s.nodeId]:s.roomName})),C(t=>({...t,[s.nodeId]:!1}))},children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"flex items-center gap-2 px-3 md:px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg text-sm hover:bg-gray-50 transition-colors cursor-pointer flex-shrink-0",onClick:()=>C(t=>({...t,[s.nodeId]:!0})),children:[e.jsx(M,{className:"w-4 h-4"}),"Edit"]}),e.jsxs("button",{className:"px-3 md:px-4 py-2 bg-slate-700 text-white rounded-lg text-sm flex items-center gap-2 hover:bg-slate-800 transition-colors cursor-pointer flex-shrink-0",onClick:()=>D({title:s.archived?"Unarchive room":"Archive room",message:s.archived?`Unarchive ${s.roomName}? It will reappear on the dashboard.`:`Archive ${s.roomName}? It will be hidden from the dashboard but not deleted.`,onConfirm:()=>K(s.nodeId)}),children:[e.jsx(L,{className:"w-4 h-4 text-white"}),s.archived?"Unarchive":"Archive"]}),e.jsxs("button",{className:"px-3 md:px-4 py-2 bg-red-600 text-white rounded-lg text-sm flex items-center gap-2 hover:bg-red-700 transition-colors cursor-pointer flex-shrink-0",onClick:()=>D({title:"Remove room",message:`Remove ${s.roomName}? Choose whether to also delete its sensor data and related alerts. This cannot be undone.`,onConfirm:J(s.nodeId),showDeleteOption:!0}),children:[e.jsx(_,{className:"w-4 h-4 text-white"}),"Delete"]})]})})})]},s.nodeId||a))]}),e.jsxs("div",{className:"mt-12 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium",children:"Phone Numbers"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Manage emergency and notification contacts"})]}),e.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors cursor-pointer",onClick:X,children:[e.jsx(oe,{className:"w-4 h-4"}),"Add Phone Number"]})]}),e.jsxs("div",{className:"space-y-4",children:[T.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No phone numbers found."}),T.map(s=>e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-gray-200 flex flex-col md:flex-row items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full md:w-auto flex-1",children:[e.jsx("div",{className:"w-14 h-14 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(ne,{className:"text-2xl text-red-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-base font-semibold text-gray-900",children:s.label}),e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:s.number})]})]}),e.jsxs("div",{className:"w-full md:w-auto flex items-center gap-3",children:[e.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>Y(s),children:[e.jsx(M,{className:"w-4 h-4"}),"Edit"]}),e.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors cursor-pointer",onClick:()=>ee(s.id),children:[e.jsx(_,{className:"w-4 h-4"}),"Delete"]})]})]},s.id))]})]}),d.open&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",role:"dialog","aria-modal":"true","aria-labelledby":"phone-modal-title",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg max-w-md w-full mx-4 p-6",children:[e.jsx("h3",{id:"phone-modal-title",className:"text-lg font-semibold text-gray-900 mb-4",children:d.mode==="add"?"Add Phone Number":"Edit Phone Number"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Label"}),e.jsx("input",{type:"text",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",placeholder:"e.g., Emergency Contact",value:d.label,onChange:s=>S(a=>({...a,label:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone Number"}),e.jsx("input",{type:"tel",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500",placeholder:"e.g., +639456789012",value:d.number,onChange:s=>S(a=>({...a,number:s.target.value}))})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{className:"px-6 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors cursor-pointer",onClick:q,children:"Cancel"}),e.jsx("button",{className:"px-6 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors cursor-pointer",onClick:Z,children:d.mode==="add"?"Add":"Save"})]})]})}),i.open&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-title",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg max-w-lg w-full mx-4 p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 ${i.showDeleteOption?"bg-red-100":"bg-slate-700"}`,children:i.showDeleteOption?e.jsx(_,{className:"w-5 h-5 text-red-600"}):e.jsx(L,{className:"w-5 h-5 text-white"})}),e.jsx("div",{children:e.jsx("h3",{id:"confirm-title",className:"text-lg font-semibold text-gray-900",children:i.title})})]}),e.jsx("p",{className:"text-sm text-gray-700 mb-6",children:i.message}),i.showDeleteOption&&e.jsx("div",{className:"mb-6",children:e.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:i.deleteOption,onChange:()=>l(s=>({...s,deleteOption:!s.deleteOption})),className:"w-5 h-5 accent-red-600 cursor-pointer"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Also delete sensor data and related alerts"})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:"px-6 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50",onClick:()=>l({open:!1,title:"",message:"",onConfirm:null}),disabled:c,children:"Cancel"}),e.jsx("button",{className:"px-6 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors disabled:opacity-50",onClick:Q,disabled:c,children:c?"Please wait...":"Confirm"})]})]})})]}),e.jsx(ge,{isOpen:V,onClose:()=>R(!1),onSuccess:()=>{}})]})}const Ne=Object.freeze(Object.defineProperty({__proto__:null,default:be},Symbol.toStringTag,{value:"Module"}));export{ge as C,Ne as S};
